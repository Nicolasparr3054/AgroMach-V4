<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroMatch - Dashboard Trabajador</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <link rel="stylesheet" href="../assent/css/index-trabajador.css">
    <!-- Leaflet CSS y JS (Reemplazo de Google Maps) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="../js/index-trabajador.js"></script>
</head>
<body>
    <!-- Overlay para modales -->
    <div class="overlay" id="overlay"></div>
    
    <!-- Modal para confirmar postulación -->
    <div class="modal" id="applyJobModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Confirmar Postulación</h2>
                <button class="close-btn" onclick="closeApplyModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que quieres postularte a este trabajo?</p>
                <div id="jobDetailsForApplication"></div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeApplyModal()">
                    Cancelar
                </button>
                <button class="btn btn-primary" onclick="confirmApplication()" id="confirmApplyBtn">
                    <i class="fas fa-paper-plane"></i> Confirmar Postulación
                </button>
            </div>
        </div>
    </div>
    
    <!-- Dropdown dinámico del perfil -->
    <div id="dynamicProfileDropdown" style="
        position: fixed;
        top: 80px;
        right: 30px;
        z-index: 9999;
        min-width: 280px;
        display: none;
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        pointer-events: none;
    ">
        <div class="dynamic-dropdown-content">
            <div class="dynamic-dropdown-header">
                <div class="dynamic-dropdown-avatar profile-photo" id="dropdownAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="dynamic-dropdown-name" id="dropdownName">Cargando...</div>
                <div class="dynamic-dropdown-role">
                    <i class="fas fa-seedling"></i>
                    <span>Trabajador Agrícola</span>
                </div>
            </div>
            <div class="dynamic-dropdown-menu">
                <div class="dynamic-dropdown-item" onclick="showProfile()">
                    <div class="icon"><i class="fas fa-user-circle"></i></div>
                    <span>Ver Perfil</span>
                </div>
                <div class="dynamic-dropdown-item" onclick="showStats()">
                    <div class="icon"><i class="fas fa-chart-bar"></i></div>
                    <span>Mis Estadísticas</span>
                </div>
                <div class="dynamic-dropdown-item" onclick="showHistorialEmpleos()">
                    <div class="icon"><i class="fas fa-history"></i></div>
                    <span>Historial de Empleos</span>
                </div>
                <div class="dynamic-dropdown-item" onclick="showPostulaciones()">
                    <div class="icon"><i class="fas fa-paper-plane"></i></div>
                    <span>Mis Postulaciones</span>
                </div>
                <div class="dynamic-dropdown-item" onclick="showFavoritos()">
                    <div class="icon"><i class="fas fa-heart"></i></div>
                    <span>Mis Favoritos</span>
                </div>
                <div class="dynamic-dropdown-item" onclick="showSettings()">
                    <div class="icon"><i class="fas fa-cog"></i></div>
                    <span>Configuración</span>
                </div>
                <div class="dynamic-dropdown-item logout" onclick="logout()">
                    <div class="icon"><i class="fas fa-sign-out-alt"></i></div>
                    <span>Cerrar Sesión</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                 <img src="../assent/img/logo.jpg" alt="AgroMatch Logo" style="height:40px;">
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="searchJobs()">
                    <i class="fas fa-search"></i> Buscar Trabajos
                </button>
                <div class="notification-icon" onclick="showNotifications()">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">2</span>
                </div>
                <div class="profile-menu profile-photo" id="profileMenuBtn" onclick="toggleProfileMenu()">
                    <i class="fas fa-user"></i>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="dashboard">
            <div class="main-panel">
                <!-- Search and Filters -->
                <div class="search-container">
                    <input type="text" class="search-bar" placeholder="Buscar trabajos por ubicación, tipo de cultivo, etc..." oninput="filterJobs(this.value)">
                    <i class="fas fa-search search-icon"></i>
                </div>

                <div class="filter-container">
                    <button class="filter-btn active" onclick="filterByType(this, 'todos')">Todos</button>
                    <button class="filter-btn" onclick="filterByType(this, 'cosecha')">Cosecha</button>
                    <button class="filter-btn" onclick="filterByType(this, 'siembra')">Siembra</button>
                    <button class="filter-btn" onclick="filterByType(this, 'mantenimiento')">Mantenimiento</button>
                    <button class="filter-btn" onclick="filterByType(this, 'recoleccion')">Recolección</button>
                </div>

                <!-- Quick Stats -->
                <div class="quick-stats">
                    <div class="quick-stat">
                        <div class="quick-stat-number" id="jobsNearCount">0</div>
                        <div class="quick-stat-label">Trabajos Cerca</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-number" id="applicationsCount">0</div>
                        <div class="quick-stat-label">Postulaciones</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-number" id="activeJobsCount">0</div>
                        <div class="quick-stat-label">En Progreso</div>
                    </div>
                </div>

                <div class="section-title">
                    <i class="fas fa-briefcase"></i>
                    Trabajos Disponibles
                </div>
                
                <!-- Contenedor de trabajos que se llenará dinámicamente -->
                <div class="job-list" id="jobsList">
                    <!-- Los trabajos se cargarán aquí dinámicamente -->
                </div>
                
                <!-- Mensaje cuando no hay trabajos -->
                <div class="no-jobs" id="noJobsMessage" style="display: none;">
                    <div class="no-jobs-content">
                        <i class="fas fa-briefcase"></i>
                        <h3>No hay trabajos disponibles</h3>
                        <p>No se encontraron ofertas de trabajo que coincidan con tus criterios.</p>
                    </div>
                </div>

                <!-- My Jobs Section -->
                <div class="my-jobs">
                    <div class="section-title">
                        <i class="fas fa-tasks"></i>
                        Mis Trabajos
                    </div>
                    
                    <!-- Contenedor de mis trabajos que se llenará dinámicamente -->
                    <div id="myJobsList">
                        <!-- Los trabajos aceptados se cargarán aquí -->
                    </div>
                    
                    <!-- Mensaje cuando no tengo trabajos -->
                    <div class="no-my-jobs" id="noMyJobsMessage" style="display: none;">
                        <div class="no-jobs-content">
                            <i class="fas fa-tasks"></i>
                            <h3>No tienes trabajos activos</h3>
                            <p>Postúlate a las ofertas disponibles para empezar a trabajar.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="side-panel">
                <!-- Profile Section -->
                <div class="profile-section">
                    <div class="profile-avatar profile-photo" id="profileAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="profile-name" id="profileName">Cargando...</div>
                    
                    <div class="rating">
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <span class="rating-value">4.8</span>
                    </div>
                    
                    <div class="profile-stats">
                        <div class="profile-stat">
                            <div class="stat-value" id="totalJobs">0</div>
                            <div class="stat-label">Trabajos</div>
                        </div>
                        <div class="profile-stat">
                            <div class="stat-value" id="totalHours">0h</div>
                            <div class="stat-label">Horas</div>
                        </div>
                    </div>
                </div>

                <!-- Map Section -->
                <div class="section-title">
                    <i class="fas fa-map"></i>
                    Trabajos Cercanos
                </div>
                <div id="map" style="height: 300px; border-radius: 15px; overflow: hidden; border: 2px solid #4a7c59;"></div>

                <!-- Notifications -->
                <div class="notifications">
                    <div class="section-title">
                        <i class="fas fa-bell"></i>
                        Notificaciones
                    </div>
                    
                    <div id="notificationsList">
                        <!-- Las notificaciones se cargarán aquí dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedJobId = null;
        
        // Cargar datos al inicializar la página
        document.addEventListener('DOMContentLoaded', function() {
            loadUserProfile();
            loadAvailableJobs();
            loadMyJobs();
            loadStats();
            setTimeout(loadUserProfilePhoto, 1000);
        });
        
        // Cargar trabajos disponibles
        function loadAvailableJobs() {
            fetch('/api/get_jobs')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayJobs(data.jobs);
                    updateJobsCount(data.jobs.length);
                } else {
                    showNoJobsMessage();
                }
            })
            .catch(error => {
                console.error('Error al cargar trabajos:', error);
                showNoJobsMessage();
            });
        }
        
        // Mostrar trabajos en la interfaz
        function displayJobs(jobs) {
            const jobsList = document.getElementById('jobsList');
            const noJobsMessage = document.getElementById('noJobsMessage');
            
            if (jobs.length === 0) {
                showNoJobsMessage();
                return;
            }
            
            jobsList.innerHTML = '';
            noJobsMessage.style.display = 'none';
            
            jobs.forEach(job => {
                const jobCard = createJobCard(job);
                jobsList.appendChild(jobCard);
            });
        }
        
        // Crear tarjeta de trabajo
        function createJobCard(job) {
            const div = document.createElement('div');
            div.className = 'job-card';
            div.innerHTML = `
                <div class="job-header">
                    <div class="job-title">${job.titulo}</div>
                    <div class="job-salary">$${Number(job.pago_ofrecido).toLocaleString()}/día</div>
                </div>
                <div class="job-details">
                    ${job.descripcion}
                </div>
                <div class="job-location">
                    <i class="fas fa-user"></i>
                    ${job.nombre_agricultor} • Publicado: ${formatDate(job.fecha_publicacion)}
                </div>
                <div class="job-footer">
                    <div class="job-tags">
                        <span class="job-tag">${job.estado}</span>
                    </div>
                    <div class="job-actions">
                        <button class="favorite-btn" onclick="toggleFavorite(this, ${job.id_oferta})">
                            <i class="far fa-heart"></i>
                        </button>
                        <button class="apply-btn" onclick="showApplyModal(${job.id_oferta}, '${job.titulo}')">
                            <i class="fas fa-paper-plane"></i> Postularme
                        </button>
                    </div>
                </div>
            `;
            return div;
        }
        
        // Mostrar modal de postulación
        function showApplyModal(jobId, jobTitle) {
            selectedJobId = jobId;
            document.getElementById('jobDetailsForApplication').innerHTML = `
                <strong>Trabajo:</strong> ${jobTitle}
            `;
            document.getElementById('applyJobModal').style.display = 'flex';
            document.getElementById('overlay').style.display = 'block';
        }
        
        // Cerrar modal de postulación
        function closeApplyModal() {
            document.getElementById('applyJobModal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
            selectedJobId = null;
        }
        
        // Confirmar postulación
        function confirmApplication() {
            if (!selectedJobId) return;
            
            fetch('/api/apply_job', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    job_id: selectedJobId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Postulación enviada exitosamente');
                    closeApplyModal();
                    loadAvailableJobs(); // Recargar trabajos
                    loadStats(); // Actualizar estadísticas
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error de conexión. Intenta de nuevo.');
            });
        }
        
        // Cargar mis trabajos
        function loadMyJobs() {
            fetch('/api/get_my_jobs')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.jobs.length > 0) {
                    displayMyJobs(data.jobs);
                } else {
                    document.getElementById('noMyJobsMessage').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error al cargar mis trabajos:', error);
            });
        }
        
        // Mostrar mis trabajos
        function displayMyJobs(jobs) {
            const myJobsList = document.getElementById('myJobsList');
            const noMyJobsMessage = document.getElementById('noMyJobsMessage');
            
            myJobsList.innerHTML = '';
            noMyJobsMessage.style.display = 'none';
            
            jobs.forEach(job => {
                const jobCard = createMyJobCard(job);
                myJobsList.appendChild(jobCard);
            });
        }
        
        // Crear tarjeta de mi trabajo
        function createMyJobCard(job) {
            const div = document.createElement('div');
            div.className = 'job-card';
            
            let statusClass = '';
            let statusText = '';
            
            switch(job.estado) {
                case 'Pendiente':
                    statusClass = 'status-pending';
                    statusText = 'Pendiente';
                    break;
                case 'Aceptada':
                    statusClass = 'status-confirmed';
                    statusText = 'Confirmado';
                    break;
                case 'Rechazada':
                    statusClass = 'status-rejected';
                    statusText = 'Rechazado';
                    break;
            }
            
            div.innerHTML = `
                <div class="job-header">
                    <div class="job-title">${job.titulo}</div>
                    <div class="job-status ${statusClass}">${statusText}</div>
                </div>
                <div class="job-details">
                    ${job.descripcion}
                </div>
                <div class="job-location">
                    <i class="fas fa-calendar"></i>
                    Postulado: ${formatDate(job.fecha_postulacion)}
                </div>
                <div class="job-footer">
                    <div class="job-tags">
                        <span class="job-tag">${job.estado}</span>
                    </div>
                </div>
            `;
            return div;
        }
        
        // Cargar estadísticas
        function loadStats() {
            fetch('/api/get_worker_stats')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('applicationsCount').textContent = data.applications || 0;
                    document.getElementById('activeJobsCount').textContent = data.active_jobs || 0;
                    document.getElementById('totalJobs').textContent = data.total_jobs || 0;
                    document.getElementById('totalHours').textContent = (data.total_hours || 0) + 'h';
                }
            })
            .catch(error => {
                console.error('Error al cargar estadísticas:', error);
            });
        }
        
        // Cargar perfil de usuario
        function loadUserProfile() {
            fetch('/api/get_user_profile')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const fullName = data.user.nombre + ' ' + data.user.apellido;
                    document.getElementById('profileName').textContent = fullName;
                    document.getElementById('dropdownName').textContent = fullName;
                }
            })
            .catch(error => {
                console.error('Error al cargar perfil:', error);
            });
        }
        
        // Funciones auxiliares
        function showNoJobsMessage() {
            document.getElementById('jobsList').innerHTML = '';
            document.getElementById('noJobsMessage').style.display = 'block';
        }
        
        function updateJobsCount(count) {
            document.getElementById('jobsNearCount').textContent = count;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES');
        }
        
        function toggleFavorite(button, jobId) {
            // Implementar funcionalidad de favoritos
            const icon = button.querySelector('i');
            if (icon.classList.contains('far')) {
                icon.classList.remove('far');
                icon.classList.add('fas');
                icon.style.color = '#e74c3c';
            } else {
                icon.classList.remove('fas');
                icon.classList.add('far');
                icon.style.color = '';
            }
        }
        
        // Filtros
        function filterJobs(searchTerm) {
            const jobCards = document.querySelectorAll('.job-card');
            jobCards.forEach(card => {
                const title = card.querySelector('.job-title').textContent.toLowerCase();
                const description = card.querySelector('.job-details').textContent.toLowerCase();
                
                if (title.includes(searchTerm.toLowerCase()) || description.includes(searchTerm.toLowerCase())) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        function filterByType(button, type) {
            // Remover clase active de todos los botones
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Agregar clase active al botón seleccionado
            button.classList.add('active');
            
            // Si type es 'todos', mostrar todos los trabajos
            if (type === 'todos') {
                loadAvailableJobs();
            } else {
                // Filtrar por tipo específico
                const jobCards = document.querySelectorAll('.job-card');
                jobCards.forEach(card => {
                    const title = card.querySelector('.job-title').textContent.toLowerCase();
                    if (title.includes(type)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            }
        }
    </script>
</body>
</html>